---

apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ $.Release.Namespace }}
  name: alertmanager
data:
  config.yml: |-
    global:
      smtp_smarthost: {{ $.Values.smtp.host }}
      smtp_auth_username: {{ $.Values.smtp.user }}
      smtp_auth_password: {{ $.Values.smtp.pass }}
      smtp_from: {{ $.Values.smtp.from }}
      resolve_timeout: 5m
      slack_api_url: {{ $.Values.slack.hook }}

    templates:
    - '/etc/alertmanager-templates/*.tmpl'
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 10s
      group_interval: 1m
      repeat_interval: 5m
      receiver: default
      routes:
      - match:
          team: devops
        receiver: devops
        continue: true
      - match:
          team: dev
        receiver: dev
        continue: true

    receivers:
    - name: 'default'

    - name: 'devops'
      slack_configs:
      - channel: #{{ $.Values.slack.channel }}
        send_resolved: true
        title: '[{{`{{ .Status | toUpper }}`}}{{`{{ if eq .Status "firing" }}`}}:{{`{{ .Alerts.Firing | len }}`}}{{`{{ end }}`}}] Monitoring Event Notification'
        text: >-
          {{`{{ range .Alerts }}`}}
            *Alert:* {{`{{ .Annotations.summary }}`}} - \`{{`{{ .Labels.severity }}`}}\`
            *Description:* {{`{{ .Annotations.description }}`}}
            *Details:*
            {{`{{ range .Labels.SortedPairs }}`}} • *{{`{{ .Name }}`}}:* \`{{`{{ .Value }}`}}\`
            {{`{{ end }}`}}
          {{`{{ end }}`}}

    - name: 'dev'
      slack_configs:
      - channel: #{{ $.Values.slack.channel }}
        send_resolved: true
        title: '[{{`{{ .Status | toUpper }}`}}{{`{{ if eq .Status "firing" }}`}}:{{`{{ .Alerts.Firing | len }}`}}{{`{{ end }}`}}] Monitoring Event Notification'
        text: >-
          {{`{{ range .Alerts }}`}}
            *Alert:* {{`{{ .Annotations.summary }}`}} - \`{{`{{ .Labels.severity }}`}}\`
            *Description:* {{`{{ .Annotations.description }}`}}
            *Details:*
            {{`{{ range .Labels.SortedPairs }}`}} • *{{`{{ .Name }}`}}:* \`{{`{{ .Value }}`}}\`
            {{`{{ end }}`}}
          {{`{{ end }}`}}