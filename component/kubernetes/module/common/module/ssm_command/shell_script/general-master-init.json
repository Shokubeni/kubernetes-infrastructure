{
  "schemaVersion": "2.2",
  "description": "Initialize general master node",
  "parameters": {
    "S3BucketName": {
      "type": "String"
    },
    "BalancerDNS": {
      "type": "String"
    },
    "ClusterId": {
      "type": "String"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "Initialization",
      "inputs": {
        "runCommand": [
          "sudo su",

          "cat <<EOF >./kubeadm-config.yaml",
          "apiVersion: kubeadm.k8s.io/v1beta1",
          "kind: InitConfiguration",
          "nodeRegistration:",
          "  kubeletExtraArgs:",
          "    cloud-provider: \"aws\"",
          "---",
          "apiVersion: kubeadm.k8s.io/v1beta1",
          "kind: ClusterConfiguration",
          "kubernetesVersion: stable",
          "clusterName: \"{{ ClusterId }}\"",
          "controlPlaneEndpoint: \"{{ BalancerDNS }}:6443\"",
          "apiServer:",
          "  extraArgs:",
          "    cloud-provider: \"aws\"",
          "  certSANs:",
          "  - \"{{ BalancerDNS }}\"",
          "controllerManager:",
          "  extraArgs:",
          "    cloud-provider: \"aws\"",
          "EOF",

          "kubeadm init --config=kubeadm-config.yaml | grep 'kubeadm join' > join-command",
          "mkdir -p $HOME/.kube",
          "cp -i /etc/kubernetes/admin.conf $HOME/.kube/config",
          "chown $(id -u):$(id -g) $HOME/.kube/config",
          "export KUBECONFIG=$HOME/.kube/config",
          "kubectl apply -f \"https://cloud.weave.works/k8s/net?k8s-version=$(kubectl version | base64 | tr -d '\\n')\"",
          "aws s3 cp /etc/kubernetes/pki/ca.crt s3://{{ S3BucketName }}/certificates/ca.crt",
          "aws s3 cp /etc/kubernetes/pki/ca.key s3://{{ S3BucketName }}/certificates/ca.key",
          "aws s3 cp /etc/kubernetes/pki/sa.key s3://{{ S3BucketName }}/certificates/sa.key",
          "aws s3 cp /etc/kubernetes/pki/sa.pub s3://{{ S3BucketName }}/certificates/sa.pub",
          "aws s3 cp /etc/kubernetes/pki/front-proxy-ca.crt s3://{{ S3BucketName }}/certificates/front-proxy-ca.crt",
          "aws s3 cp /etc/kubernetes/pki/front-proxy-ca.key s3://{{ S3BucketName }}/certificates/front-proxy-ca.key",
          "aws s3 cp /etc/kubernetes/pki/etcd/ca.crt s3://{{ S3BucketName }}/certificates/etcd/ca.crt",
          "aws s3 cp /etc/kubernetes/pki/etcd/ca.key s3://{{ S3BucketName }}/certificates/etcd/ca.key",
          "aws s3 cp /etc/kubernetes/admin.conf s3://{{ S3BucketName }}/certificates/admin.conf",
          "aws s3 cp ./join-command s3://{{ S3BucketName }}/commands/join-command",


          "aws s3 cp /etc/kubernetes/pki/ca.crt s3://{{ S3BucketName }}/certificates/ca.crt --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/ca.key s3://{{ S3BucketName }}/certificates/ca.key --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/sa.key s3://{{ S3BucketName }}/certificates/sa.key --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/sa.pub s3://{{ S3BucketName }}/certificates/sa.pub --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/front-proxy-ca.crt s3://{{ S3BucketName }}/certificates/front-proxy-ca.crt --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/front-proxy-ca.key s3://{{ S3BucketName }}/certificates/front-proxy-ca.key --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/etcd/ca.crt s3://{{ S3BucketName }}/certificates/etcd/ca.crt --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/pki/etcd/ca.key s3://{{ S3BucketName }}/certificates/etcd/ca.key --content-type \"text/plain\"",
          "aws s3 cp /etc/kubernetes/admin.conf s3://{{ S3BucketName }}/configs/kubernetes.conf --content-type \"text/plain\"",
          "aws s3 cp ./join-command s3://{{ S3BucketName }}/commands/join-command --content-type \"text/plain\"",
          "rm ./join-command"
        ]
      }
    }
  ]
}