{
  "schemaVersion": "2.2",
  "description": "Backup etcd database",
  "parameters": {
    "S3BucketName": {
      "type": "String"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "Backup",
      "inputs": {
        "runCommand": [
          "sudo su",
          "ETCD_BACKUP_DATE=$(date +\"%y-%m-%d_%T\")",
          "ETCDCTL_API=3 etcdctl  --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key /etc/kubernetes/pki/etcd/healthcheck-client.key snapshot save ./snapshot_$ETCD_BACKUP_DATE.db",
          "aws s3 cp ./snapshot_$ETCD_BACKUP_DATE.db s3://{{ S3BucketName }}/snapshots/snapshot_$ETCD_BACKUP_DATE.db",
          "rm ./snapshot_$ETCD_BACKUP_DATE.db"
        ]
      }
    }
  ]
}