{
  "schemaVersion": "2.2",
  "description": "Restore etcd database",
  "parameters": {
    "S3BucketRegion": {
      "type": "String"
    },
    "S3BucketName": {
      "type": "String"
    },
    "SnapshotName": {
      "type": "String"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "Backup",
      "inputs": {
        "runCommand": [
          "sudo su",

          "aws s3 cp s3://{{ S3BucketName }}/certificates/ca.crt /etc/kubernetes/pki/ca.crt --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/ca.key /etc/kubernetes/pki/ca.key --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/sa.key /etc/kubernetes/pki/sa.key --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/sa.pub /etc/kubernetes/pki/sa.pub --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/front-proxy-ca.crt /etc/kubernetes/pki/front-proxy-ca.crt --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/front-proxy-ca.key /etc/kubernetes/pki/front-proxy-ca.key --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/etcd/ca.crt /etc/kubernetes/pki/etcd/ca.crt --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/certificates/etcd/ca.key /etc/kubernetes/pki/etcd/ca.key --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/configs/kubernetes.conf /etc/kubernetes/admin.conf --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/configs/kubeadm.conf ./kubeadm-config.yaml --region {{ S3BucketRegion }}",
          "aws s3 cp s3://{{ S3BucketName }}/{{ SnapshotName }} ./{{ SnapshotName }} --region {{ S3BucketRegion }}",

          "rm -rf /var/lib/etcd",
          "mkdir -p /var/lib/etcd",
          "ETCDCTL_API=3 etcdctl snapshot restore ./{{ SnapshotName }}",
          "mv default.etcd/member/ /var/lib/etcd/",
          "rm ./{{ SnapshotName }}",
          "rm -rf default.etcd",

          "kubeadm init --ignore-preflight-errors=DirAvailable--var-lib-etcd --config=kubeadm-config.yaml",
          "mkdir -p $HOME/.kube",
          "cp -i /etc/kubernetes/admin.conf $HOME/.kube/config",
          "chown $(id -u):$(id -g) $HOME/.kube/config",
          "export KUBECONFIG=$HOME/.kube/config",

          "kubeadm token create --print-join-command > join-command",
          "aws s3 cp ./join-command s3://{{ S3BucketName }}/commands/join-command --region {{ S3BucketRegion }} --content-type \"text/plain\"",
          "rm ./join-command"
        ]
      }
    }
  ]
}