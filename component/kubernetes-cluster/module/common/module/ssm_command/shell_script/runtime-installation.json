{
  "schemaVersion": "2.2",
  "description": "Cluster nodes runtime installation",
  "parameters": {
    "KubernetesVersion": {
      "type": "String"
    },
    "DockerVersion": {
      "type": "String"
    }
  },
  "mainSteps": [
    {
      "action": "aws:runShellScript",
      "name": "Installation",
      "inputs": {
        "runCommand": [
          "sudo su",
          "echo \"export KUBECONFIG=/root/.kube/config\" >> /root/.bashrc",
          "echo \"export PATH=/root/bin:$PATH\" >> /root/.bashrc",
          "echo \"export HOME=/root\" >> /root/.bashrc",
          "mkdir -p /root/bin",
          "hostnamectl set-hostname $(ec2metadata --local-hostname)",

          "apt-get update",
          "apt-get install -y awscli nfs-common dialog apt-utils apt-transport-https ca-certificates curl gnupg-agent software-properties-common",
          "curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -",
          "add-apt-repository \"deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable\"",
          "curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | apt-key add -",
          "add-apt-repository \"deb https://apt.kubernetes.io/ kubernetes-xenial main\"",

          "apt-get update",
          "apt-get install -y docker-ce={{ DockerVersion }}* kubelet={{ KubernetesVersion }}* kubeadm={{ KubernetesVersion }}* kubectl={{ KubernetesVersion }}*",
          "apt-mark hold kubelet kubeadm kubectl",

          "cat > /etc/docker/daemon.json <<EOF",
          "{",
            "\"exec-opts\": [\"native.cgroupdriver=systemd\"],",
            "\"log-driver\": \"json-file\",",
            "\"log-opts\": {",
              "\"max-size\": \"100m\"",
            "},",
            "\"storage-driver\": \"overlay2\"",
          "}",
          "EOF",
          "systemctl daemon-reload",
          "systemctl restart docker"
        ]
      }
    }
  ]
}
